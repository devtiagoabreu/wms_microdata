<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Etiquetas - Regras Corrigidas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-barcode"></i> Gerador de Etiquetas</h1>
            <p class="subtitle">Regras: 3ª parte (01-05) → 2ª parte (01-99) → 1ª parte</p>
        </header>

        <main>
            <div class="card">
                <h2><i class="fas fa-cog"></i> Configuração</h2>
                
                <form id="form-etiquetas">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="inicio">
                                <i class="fas fa-play"></i> Código Inicial
                            </label>
                            <input type="text" id="inicio" name="inicio" 
                                   placeholder="ex: 03.49.01.00" 
                                   value="03.49.01.00" required
                                   pattern="\d{2}\.\d{2}\.\d{2}\.\d{2}">
                            <small>Formato: XX.XX.XX.XX (4ª parte sempre 00)</small>
                        </div>

                        <div class="form-group">
                            <label for="fim">
                                <i class="fas fa-stop"></i> Código Final
                            </label>
                            <input type="text" id="fim" name="fim" 
                                   placeholder="ex: 03.50.05.00" 
                                   value="03.50.05.00" required
                                   pattern="\d{2}\.\d{2}\.\d{2}\.\d{2}">
                            <small>Formato: XX.XX.XX.XX (4ª parte sempre 00)</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="endereco">
                            <i class="fas fa-map-marker-alt"></i> Endereço Completo
                        </label>
                        <textarea id="endereco" name="endereco" rows="3" 
                                  placeholder="RUA | PRÉDIO | NÍVEL | APARTAMENTO" required>RUA | PRÉDIO | NÍVEL | APARTAMENTO</textarea>
                    </div>

                    <div class="info-box">
                        <h3><i class="fas fa-info-circle"></i> Resumo</h3>
                        <div class="info-grid">
                            <div>
                                <p><strong>Quantidade:</strong> <span id="quantidade">10</span> etiquetas</p>
                                <p><strong>Páginas:</strong> <span id="paginas">5</span> páginas</p>
                            </div>
                            <div>
                                <p><strong>Status:</strong> <span id="status" class="status-valid">Válido</span></p>
                                <p><strong>4ª parte:</strong> <span id="quarta-parte">00 (fixo)</span></p>
                            </div>
                        </div>
                        <p><strong>Sequência:</strong> <span id="sequencia-exemplo"></span></p>
                        <p><strong>Arquivo:</strong> <span id="nome-arquivo">etiquetas_03.49.01.00_a_03.50.05.00.pdf</span></p>
                    </div>

                    <div class="buttons">
                        <button type="button" id="btn-testar" class="btn btn-secondary">
                            <i class="fas fa-vial"></i> Ver Sequência
                        </button>
                        <button type="submit" id="btn-gerar" class="btn btn-primary">
                            <i class="fas fa-file-pdf"></i> Gerar PDF
                        </button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2><i class="fas fa-sitemap"></i> Regras de Incremento</h2>
                <div class="rules-diagram">
                    <div class="rule-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>4ª Parte (FIXA)</h4>
                            <p class="fixed-part">Sempre <strong>00</strong></p>
                            <p>Nunca muda</p>
                        </div>
                    </div>
                    
                    <div class="rule-arrow">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    
                    <div class="rule-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>3ª Parte (VARIA de 01 a 05)</h4>
                            <p class="variable-part">Ex: <strong>01</strong> → <strong>02</strong> → ... → <strong>05</strong></p>
                            <p>Quando chega em 05, reseta para 01</p>
                        </div>
                    </div>
                    
                    <div class="rule-arrow">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    
                    <div class="rule-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>2ª Parte (VARIA de 01 a 99)</h4>
                            <p class="variable-part">Ex: <strong>49</strong> → <strong>50</strong> → ... → <strong>99</strong></p>
                            <p>Quando chega em 99, reseta para 01</p>
                        </div>
                    </div>
                    
                    <div class="rule-arrow">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    
                    <div class="rule-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h4>1ª Parte (FIXA ou VARIA)</h4>
                            <p class="fixed-part">Ex: <strong>03</strong> (normalmente fixo)</p>
                            <p>Só incrementa se 2ª parte passar de 99</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-calculator"></i> Exemplos de Cálculo</h2>
                <div class="calculation-examples">
                    <div class="calculation">
                        <h4>Exemplo 1: <code>03.49.01.00</code> até <code>03.49.05.00</code></h4>
                        <div class="calc-steps">
                            <p>1. 3ª parte: 01 → 02 → 03 → 04 → 05</p>
                            <p>2ª parte permanece 49</p>
                            <p><strong>Total: 5 etiquetas</strong></p>
                        </div>
                    </div>
                    
                    <div class="calculation">
                        <h4>Exemplo 2: <code>03.49.01.00</code> até <code>03.50.05.00</code></h4>
                        <div class="calc-steps">
                            <p>1. 03.49.01.00 → 03.49.02.00 → 03.49.03.00 → 03.49.04.00 → 03.49.05.00</p>
                            <p>2. 03.50.01.00 → 03.50.02.00 → 03.50.03.00 → 03.50.04.00 → 03.50.05.00</p>
                            <p><strong>Total: 10 etiquetas</strong></p>
                        </div>
                    </div>
                    
                    <div class="calculation">
                        <h4>Exemplo 3: <code>05.28.01.00</code> até <code>05.28.05.00</code> (PDF original)</h4>
                        <div class="calc-steps">
                            <p>1. 05.28.01.00 → 05.28.02.00 (página 1)</p>
                            <p>2. 05.28.03.00 → 05.28.04.00 (página 2)</p>
                            <p>3. 05.28.05.00 (página 3 - única etiqueta)</p>
                            <p><strong>Total: 5 etiquetas em 3 páginas</strong></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-question-circle"></i> FAQ - Perguntas Frequentes</h2>
                <div class="faq">
                    <div class="faq-item">
                        <h4>Por que a 3ª parte só vai até 05?</h4>
                        <p>É a regra do sistema de endereçamento. Cada "bloco" tem 5 posições (01 a 05).</p>
                    </div>
                    
                    <div class="faq-item">
                        <h4>E se eu quiser gerar mais de 5 etiquetas seguidas?</h4>
                        <p>O sistema automaticamente incrementa a 2ª parte. Ex: 03.49.05.00 → 03.50.01.00</p>
                    </div>
                    
                    <div class="faq-item">
                        <h4>A 4ª parte pode ser diferente de 00?</h4>
                        <p>Não. No seu sistema, a 4ª parte é sempre 00.</p>
                    </div>
                    
                    <div class="faq-item">
                        <h4>Quantas páginas serão geradas?</h4>
                        <p>Cada página tem 2 etiquetas. Ex: 10 etiquetas = 5 páginas.</p>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>Gerador de Etiquetas &copy; 2024 | Regras corrigidas conforme especificado</p>
        </footer>
    </div>

    <div id="loading" class="loading-overlay">
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p>Gerando PDF com layout específico...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('form-etiquetas');
            const inicioInput = document.getElementById('inicio');
            const fimInput = document.getElementById('fim');
            const enderecoInput = document.getElementById('endereco');
            const quantidadeSpan = document.getElementById('quantidade');
            const paginasSpan = document.getElementById('paginas');
            const statusSpan = document.getElementById('status');
            const sequenciaExemploSpan = document.getElementById('sequencia-exemplo');
            const nomeArquivoSpan = document.getElementById('nome-arquivo');
            const btnGerar = document.getElementById('btn-gerar');
            const btnTestar = document.getElementById('btn-testar');
            const loadingOverlay = document.getElementById('loading');

            function formatarNomeArquivo() {
                const inicio = inicioInput.value.trim();
                const fim = fimInput.value.trim();
                if (inicio && fim) {
                    nomeArquivoSpan.textContent = `etiquetas_${inicio}_a_${fim}.pdf`;
                    sequenciaExemploSpan.textContent = `${inicio} → ... → ${fim}`;
                }
            }

            function validarCodigo(codigo) {
                const padrao = /^\d{2}\.\d{2}\.\d{2}\.\d{2}$/;
                if (!padrao.test(codigo)) return false;
                
                // Verifica se a 4ª parte é 00
                const partes = codigo.split('.');
                return partes[3] === '00';
            }

            async function calcularQuantidade() {
                const inicio = inicioInput.value.trim();
                const fim = fimInput.value.trim();
                
                if (!inicio || !fim) return;
                
                if (!validarCodigo(inicio) || !validarCodigo(fim)) {
                    quantidadeSpan.textContent = '0';
                    paginasSpan.textContent = '0';
                    statusSpan.textContent = 'Inválido';
                    statusSpan.className = 'status-invalid';
                    sequenciaExemploSpan.textContent = '4ª parte deve ser 00';
                    btnGerar.disabled = true;
                    return;
                }
                
                try {
                    const response = await fetch('/calcular', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ inicio, fim })
                    });
                    
                    const data = await response.json();
                    
                    quantidadeSpan.textContent = data.quantidade;
                    paginasSpan.textContent = Math.ceil(data.quantidade / 2);
                    
                    if (data.valido) {
                        statusSpan.textContent = 'Válido';
                        statusSpan.className = 'status-valid';
                        btnGerar.disabled = false;
                    } else {
                        statusSpan.textContent = 'Inválido';
                        statusSpan.className = 'status-invalid';
                        btnGerar.disabled = true;
                    }
                    
                    formatarNomeArquivo();
                    
                } catch (error) {
                    console.error('Erro ao calcular:', error);
                    quantidadeSpan.textContent = '0';
                    paginasSpan.textContent = '0';
                    statusSpan.textContent = 'Erro';
                    statusSpan.className = 'status-invalid';
                    btnGerar.disabled = true;
                }
            }

            async function testarSequencia() {
                const inicio = inicioInput.value.trim();
                const fim = fimInput.value.trim();
                
                if (!inicio || !fim || !validarCodigo(inicio) || !validarCodigo(fim)) {
                    alert('Digite códigos válidos! A 4ª parte deve ser 00.');
                    return;
                }
                
                try {
                    const response = await fetch(`/sequencia/${inicio}/${fim}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    const primeiros = data.sequencia.slice(0, 3);
                    const ultimos = data.sequencia.slice(-3);
                    
                    let mensagem = `Total: ${data.total} etiquetas\n\n`;
                    
                    if (data.total <= 6) {
                        mensagem += `Sequência completa:\n${data.sequencia.join(' → ')}`;
                    } else {
                        mensagem += `Sequência:\n${primeiros.join(' → ')} → ... → ${ultimos.join(' → ')}`;
                    }
                    
                    alert(mensagem);
                    
                } catch (error) {
                    console.error('Erro ao testar:', error);
                    alert('Erro ao testar sequência');
                }
            }

            function mostrarErro(mensagem) {
                alert('Erro: ' + mensagem);
            }

            async function gerarPDF(e) {
                e.preventDefault();
                
                const inicio = inicioInput.value.trim();
                const fim = fimInput.value.trim();
                const endereco = enderecoInput.value.trim();
                
                // Validações
                if (!inicio || !fim || !endereco) {
                    mostrarErro('Preencha todos os campos');
                    return;
                }
                
                if (!validarCodigo(inicio) || !validarCodigo(fim)) {
                    mostrarErro('Formato inválido. Use: XX.XX.XX.00 (4ª parte sempre 00)');
                    return;
                }
                
                // Mostrar loading
                loadingOverlay.style.display = 'flex';
                
                try {
                    const response = await fetch('/gerar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ inicio, fim, endereco })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Erro ao gerar PDF');
                    }
                    
                    // Baixar o arquivo
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `etiquetas_${inicio}_a_${fim}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                } catch (error) {
                    console.error('Erro:', error);
                    mostrarErro(error.message);
                } finally {
                    // Esconder loading
                    loadingOverlay.style.display = 'none';
                }
            }

            // Event listeners
            inicioInput.addEventListener('input', calcularQuantidade);
            fimInput.addEventListener('input', calcularQuantidade);
            enderecoInput.addEventListener('input', formatarNomeArquivo);
            
            btnTestar.addEventListener('click', testarSequencia);
            form.addEventListener('submit', gerarPDF);

            // Calcular inicial
            calcularQuantidade();
        });
    </script>
</body>
</html>