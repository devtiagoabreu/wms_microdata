<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de etiquetas endereço para Impressora Argox</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .page-preview {
            width: 99.8mm;
            height: 79mm;
            margin: 20px auto;
            border: 2px solid #333;
            background: #f9f9f9;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .etiqueta {
            position: absolute;
            width: 90mm;
            height: 35mm;
            border: 1px solid #000; /* Borda fina */
            background: white;
        }
        
        .etiqueta-superior {
            top: 4.5mm;
            left: 4.9mm;
        }
        
        .etiqueta-inferior {
            bottom: 4.5mm;
            left: 4.9mm;
        }
        
        /* CÓDIGO DE BARRAS CENTRALIZADO E MAIOR */
        .barcode-area {
            position: absolute;
            top: 2mm;
            left: 9mm; /* Centralizado (90mm - 72mm = 18mm / 2 = 9mm) */
            width: 72mm; /* 80% de 90mm */
            height: 8.75mm; /* 25% de 35mm */
            background: repeating-linear-gradient(
                90deg,
                #000,
                #000 1mm,
                transparent 1mm,
                transparent 2mm
            );
            opacity: 0.7;
        }
        
        /* CÓDIGO MAIOR E CENTRALIZADO */
        .code-text {
            position: absolute;
            top: 12mm; /* Abaixo do código de barras */
            left: 0;
            width: 100%;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 16px; /* Aumentado */
            color: #000;
        }
        
        /* ENDEREÇO EM UMA LINHA E CENTRALIZADO */
        .address-text {
            position: absolute;
            top: 22mm; /* Centralizado verticalmente */
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 12px; /* Para caber em uma linha */
            color: #000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .page-info {
            text-align: center;
            margin-top: 10px;
            color: #666;
        }
        
        .page-info span {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .impressora-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            padding: 15px;
            background: #e8f4ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-item i {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .info-item div {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .info-item small {
            color: #7f8c8d;
            font-size: 0.85em;
        }
        
        /* Destaque para textos maiores */
        .texto-destaque {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .novidades-box {
            background: linear-gradient(135deg, #2ecc7120 0%, #27ae6020 100%);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid #2ecc71;
        }
        
        .novidades-box h4 {
            color: #27ae60;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .novidades-list {
            list-style: none;
            padding-left: 20px;
        }
        
        .novidades-list li {
            margin-bottom: 8px;
            padding-left: 25px;
            position: relative;
            color: #2c3e50;
        }
        
        .novidades-list li:before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #2ecc71;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-print"></i> Gerador para Impressora Argox - LAYOUT FINAL</h1>
            <p class="subtitle texto-destaque">Página: 99.8 × 79.0 mm • 2 etiquetas por página • Layout otimizado</p>
        </header>

        <main>
            <div class="card">
                <h2><i class="fas fa-cog"></i> Configuração das Etiquetas</h2>
                
                <div class="novidades-box">
                    <h4><i class="fas fa-star"></i>Layout Etiqueta:</h4>
                    <ul class="novidades-list">
                        <li>Código de barras centralizado e maior (80% da largura)</li>
                        <li>Código do endereço em 16pt (maior)</li>
                        <li>Endereço em UMA LINHA (12pt, centralizado)</li>
                        <li>Borda retangular fina em cada etiqueta</li>
                        <li>Todos os elementos perfeitamente centralizados</li>
                        <li>Tamanho da página: 99.8 × 79.0 mm</li>
                        <li>2 etiquetas por página</li>
                    </ul>
                </div>
                
                <form id="form-etiquetas">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="inicio">
                                <i class="fas fa-play"></i> Código Inicial
                            </label>
                            <input type="text" id="inicio" name="inicio" 
                                   placeholder="ex: 03.49.01.00" 
                                   value="03.49.01.00" required
                                   pattern="\d{2}\.\d{2}\.\d{2}\.\d{2}">
                            <small>Formato: XX.XX.XX.00 (4ª parte sempre 00)</small>
                        </div>

                        <div class="form-group">
                            <label for="fim">
                                <i class="fas fa-stop"></i> Código Final
                            </label>
                            <input type="text" id="fim" name="fim" 
                                   placeholder="ex: 03.50.05.00" 
                                   value="03.50.05.00" required
                                   pattern="\d{2}\.\d{2}\.\d{2}\.\d{2}">
                            <small>Formato: XX.XX.XX.00 (4ª parte sempre 00)</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="endereco">
                            <i class="fas fa-map-marker-alt"></i> Endereço Completo
                        </label>
                        <textarea id="endereco" name="endereco" rows="2" 
                                  placeholder="RUA | PRÉDIO | NÍVEL | APARTAMENTO" required>RUA | PRÉDIO | NÍVEL | APARTAMENTO</textarea>
                        <small class="texto-destaque">Será impresso em UMA LINHA, maior e centralizado</small>
                    </div>

                    <div class="impressora-info">
                        <div class="info-item">
                            <i class="fas fa-print"></i>
                            <div>Impressora</div>
                            <small>Argox</small>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-expand-alt"></i>
                            <div>99.8 × 79.0 mm</div>
                            <small>Tamanho da página</small>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-tags"></i>
                            <div>2 etiquetas</div>
                            <small>Por página</small>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-barcode"></i>
                            <div>Code128</div>
                            <small>80% da largura</small>
                        </div>
                    </div>

                    <!-- PRÉVIA ATUALIZADA -->
                    <div class="page-preview">
                        <div class="etiqueta etiqueta-superior">
                            <div class="barcode-area"></div>
                            <div class="code-text" id="preview-code-top">05.28.01.00</div>
                            <div class="address-text" id="preview-address-top">RUA | PRÉDIO | NÍVEL | APARTAMENTO</div>
                        </div>
                        <div class="etiqueta etiqueta-inferior">
                            <div class="barcode-area"></div>
                            <div class="code-text" id="preview-code-bottom">05.28.02.00</div>
                            <div class="address-text" id="preview-address-bottom">RUA | PRÉDIO | NÍVEL | APARTAMENTO</div>
                        </div>
                    </div>
                    <div class="page-info">
                        <span>Prévia da página (escala real: 99.8 × 79.0 mm)</span>
                        <p class="texto-destaque" style="margin-top: 5px; font-size: 0.9em;">
                            <i class="fas fa-check-circle"></i> Código: 16pt | 
                            <i class="fas fa-check-circle"></i> Endereço: 12pt (1 linha) | 
                            <i class="fas fa-check-circle"></i> Borda fina | 
                            <i class="fas fa-check-circle"></i> Tudo centralizado
                        </p>
                    </div>

                    <div class="info-box">
                        <h3><i class="fas fa-info-circle"></i> Resumo da Geração</h3>
                        <div class="info-grid">
                            <div>
                                <p><strong>Quantidade total:</strong> <span id="quantidade" class="texto-destaque">10</span> etiquetas</p>
                                <p><strong>Páginas necessárias:</strong> <span id="paginas" class="texto-destaque">5</span> páginas</p>
                            </div>
                            <div>
                                <p><strong>Status:</strong> <span id="status" class="status-valid">Válido</span></p>
                                <p><strong>Layout:</strong> 2 etiquetas/página</p>
                            </div>
                        </div>
                        <p><strong>Sequência exemplo:</strong> <span id="sequencia-exemplo">03.49.01.00 até 03.50.05.00</span></p>
                        <p><strong>Arquivo PDF:</strong> <span id="nome-arquivo">etiquetas_03.49.01.00_a_03.50.05.00.pdf</span></p>
                    </div>

                    <div class="buttons">
                        <button type="submit" id="btn-gerar" class="btn btn-primary">
                            <i class="fas fa-file-pdf"></i> Gerar PDF Final
                        </button>
                    </div>
                </form>
            </div>

            <!-- Restante do HTML mantido igual -->
            <div class="card">
                <h2><i class="fas fa-sync-alt"></i> Como Funciona o Incremento</h2>
                <div class="sequence-example">
                    <h4>Exemplo: <code>03.49.01.00</code> até <code>03.50.05.00</code></h4>
                    
                    <div class="sequence-flow">
                        <div class="flow-step">
                            <div class="step-header">Começa com:</div>
                            <div class="step-code">03.49.01.00</div>
                        </div>
                        
                        <div class="flow-arrow">
                            <i class="fas fa-arrow-right"></i>
                            <div class="arrow-label">Incrementa 3ª parte</div>
                        </div>
                        
                        <div class="flow-step">
                            <div class="step-header">Até:</div>
                            <div class="step-code">03.49.05.00</div>
                            <div class="step-note">(5 etiquetas: 01, 02, 03, 04, 05)</div>
                        </div>
                        
                        <div class="flow-arrow">
                            <i class="fas fa-arrow-right"></i>
                            <div class="arrow-label">Reseta 3ª parte para 01<br>Incrementa 2ª parte</div>
                        </div>
                        
                        <div class="flow-step">
                            <div class="step-header">Continua com:</div>
                            <div class="step-code">03.50.01.00</div>
                        </div>
                        
                        <div class="flow-arrow">
                            <i class="fas fa-arrow-right"></i>
                            <div class="arrow-label">Incrementa 3ª parte</div>
                        </div>
                        
                        <div class="flow-step">
                            <div class="step-header">Até:</div>
                            <div class="step-code">03.50.05.00</div>
                            <div class="step-note">(5 etiquetas: 01, 02, 03, 04, 05)</div>
                        </div>
                    </div>
                    
                    <div class="sequence-total">
                        <p><strong>Total: 10 etiquetas</strong> (5 da parte 49 + 5 da parte 50)</p>
                        <p><strong>Páginas: 5 páginas</strong> (2 etiquetas por página)</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-file-pdf"></i> Layout Final da Etiqueta</h2>
                <div class="specs-grid">
                    <div class="spec">
                        <div class="spec-icon">
                            <i class="fas fa-barcode"></i>
                        </div>
                        <div class="spec-content">
                            <h4>Código de Barras</h4>
                            <p><strong>Code128 centralizado</strong></p>
                            <p>80% da largura da etiqueta</p>
                        </div>
                    </div>
                    <div class="spec">
                        <div class="spec-icon">
                            <i class="fas fa-hashtag"></i>
                        </div>
                        <div class="spec-content">
                            <h4>Código do Endereço</h4>
                            <p><strong>16pt, em negrito</strong></p>
                            <p>Centralizado horizontalmente</p>
                        </div>
                    </div>
                    <div class="spec">
                        <div class="spec-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="spec-content">
                            <h4>Endereço Fixo</h4>
                            <p><strong>12pt, UMA LINHA</strong></p>
                            <p>Centralizado verticalmente</p>
                        </div>
                    </div>
                    <div class="spec">
                        <div class="spec-icon">
                            <i class="fas fa-square"></i>
                        </div>
                        <div class="spec-content">
                            <h4>Borda da Etiqueta</h4>
                            <p><strong>Retangular fina</strong></p>
                            <p>Preto, 0.5pt de espessura</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>Gerador de etiquetas endereço para Impressora Argox &copy; 2026 | Developer: Tiago de Abreu</p>
        </footer>
    </div>

    <div id="loading" class="loading-overlay">
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p>Gerando PDF com layout final...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('form-etiquetas');
            const inicioInput = document.getElementById('inicio');
            const fimInput = document.getElementById('fim');
            const enderecoInput = document.getElementById('endereco');
            const quantidadeSpan = document.getElementById('quantidade');
            const paginasSpan = document.getElementById('paginas');
            const statusSpan = document.getElementById('status');
            const sequenciaExemploSpan = document.getElementById('sequencia-exemplo');
            const nomeArquivoSpan = document.getElementById('nome-arquivo');
            const btnGerar = document.getElementById('btn-gerar');
            const loadingOverlay = document.getElementById('loading');
            
            // Elementos da prévia
            const previewCodeTop = document.getElementById('preview-code-top');
            const previewCodeBottom = document.getElementById('preview-code-bottom');
            const previewAddressTop = document.getElementById('preview-address-top');
            const previewAddressBottom = document.getElementById('preview-address-bottom');

            function atualizarPrevia() {
                const inicio = inicioInput.value.trim();
                const endereco = enderecoInput.value.trim();
                
                previewCodeTop.textContent = inicio;
                previewAddressTop.textContent = endereco;
                
                // Calcular próximo código para prévia da segunda etiqueta
                if (inicio) {
                    const padrao = /(\d{2})\.(\d{2})\.(\d{2})\.(\d{2})/;
                    const match = inicio.match(padrao);
                    
                    if (match) {
                        let [_, b, s, p, a] = match.map(Number);
                        
                        p += 1;
                        if (p > 5) {
                            p = 1;
                            s += 1;
                        }
                        
                        const proximoCodigo = `${b.toString().padStart(2, '0')}.${s.toString().padStart(2, '0')}.${p.toString().padStart(2, '0')}.${a.toString().padStart(2, '0')}`;
                        previewCodeBottom.textContent = proximoCodigo;
                        previewAddressBottom.textContent = endereco;
                    }
                }
            }

            function formatarNomeArquivo() {
                const inicio = inicioInput.value.trim();
                const fim = fimInput.value.trim();
                if (inicio && fim) {
                    nomeArquivoSpan.textContent = `etiquetas_${inicio}_a_${fim}.pdf`;
                    sequenciaExemploSpan.textContent = `${inicio} até ${fim}`;
                }
            }

            function validarCodigo(codigo) {
                const padrao = /^\d{2}\.\d{2}\.\d{2}\.\d{2}$/;
                if (!padrao.test(codigo)) return false;
                
                // Verifica se a 4ª parte é 00
                const partes = codigo.split('.');
                return partes[3] === '00';
            }

            async function calcularQuantidade() {
                const inicio = inicioInput.value.trim();
                const fim = fimInput.value.trim();
                
                if (!inicio || !fim) return;
                
                if (!validarCodigo(inicio) || !validarCodigo(fim)) {
                    quantidadeSpan.textContent = '0';
                    paginasSpan.textContent = '0';
                    statusSpan.textContent = 'Inválido';
                    statusSpan.className = 'status-invalid';
                    sequenciaExemploSpan.textContent = '4ª parte deve ser 00';
                    btnGerar.disabled = true;
                    return;
                }
                
                try {
                    const response = await fetch('/calcular', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ inicio, fim })
                    });
                    
                    const data = await response.json();
                    
                    quantidadeSpan.textContent = data.quantidade;
                    paginasSpan.textContent = Math.ceil(data.quantidade / 2);
                    
                    if (data.valido) {
                        statusSpan.textContent = 'Válido';
                        statusSpan.className = 'status-valid';
                        btnGerar.disabled = false;
                    } else {
                        statusSpan.textContent = 'Inválido';
                        statusSpan.className = 'status-invalid';
                        btnGerar.disabled = true;
                    }
                    
                    formatarNomeArquivo();
                    atualizarPrevia();
                    
                } catch (error) {
                    console.error('Erro ao calcular:', error);
                    quantidadeSpan.textContent = '0';
                    paginasSpan.textContent = '0';
                    statusSpan.textContent = 'Erro';
                    statusSpan.className = 'status-invalid';
                    btnGerar.disabled = true;
                }
            }

            function mostrarErro(mensagem) {
                alert('Erro: ' + mensagem);
            }

            async function gerarPDF(e) {
                e.preventDefault();
                
                const inicio = inicioInput.value.trim();
                const fim = fimInput.value.trim();
                const endereco = enderecoInput.value.trim();
                
                // Validações
                if (!inicio || !fim || !endereco) {
                    mostrarErro('Preencha todos os campos');
                    return;
                }
                
                if (!validarCodigo(inicio) || !validarCodigo(fim)) {
                    mostrarErro('Formato inválido. Use: XX.XX.XX.00 (4ª parte sempre 00)');
                    return;
                }
                
                // Mostrar loading
                loadingOverlay.style.display = 'flex';
                
                try {
                    const response = await fetch('/gerar', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ inicio, fim, endereco })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Erro ao gerar PDF');
                    }
                    
                    // Baixar o arquivo
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `etiquetas_${inicio}_a_${fim}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                } catch (error) {
                    console.error('Erro:', error);
                    mostrarErro(error.message);
                } finally {
                    // Esconder loading
                    loadingOverlay.style.display = 'none';
                }
            }

            // Event listeners
            inicioInput.addEventListener('input', calcularQuantidade);
            fimInput.addEventListener('input', calcularQuantidade);
            enderecoInput.addEventListener('input', function() {
                formatarNomeArquivo();
                atualizarPrevia();
            });
            
            form.addEventListener('submit', gerarPDF);

            // Calcular inicial
            calcularQuantidade();
            atualizarPrevia();
        });
    </script>
</body>
</html>